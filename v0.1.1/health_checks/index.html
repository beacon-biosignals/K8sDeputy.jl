<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Health Checks · K8sDeputy.jl</title><meta name="title" content="Health Checks · K8sDeputy.jl"/><meta property="og:title" content="Health Checks · K8sDeputy.jl"/><meta property="twitter:title" content="Health Checks · K8sDeputy.jl"/><meta name="description" content="Documentation for K8sDeputy.jl."/><meta property="og:description" content="Documentation for K8sDeputy.jl."/><meta property="twitter:description" content="Documentation for K8sDeputy.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">K8sDeputy.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../quickstart/">Quickstart</a></li><li class="is-active"><a class="tocitem" href>Health Checks</a><ul class="internal"><li><a class="tocitem" href="#Supporting-liveness-probes"><span>Supporting liveness probes</span></a></li><li><a class="tocitem" href="#Supporting-readiness-probes"><span>Supporting readiness probes</span></a></li><li><a class="tocitem" href="#Shutdown"><span>Shutdown</span></a></li></ul></li><li><a class="tocitem" href="../graceful_termination/">Graceful Termination</a></li><li><a class="tocitem" href="../api/">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Health Checks</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Health Checks</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/beacon-biosignals/K8sDeputy.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/beacon-biosignals/K8sDeputy.jl/blob/main/docs/src/health_checks.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Health-Checks"><a class="docs-heading-anchor" href="#Health-Checks">Health Checks</a><a id="Health-Checks-1"></a><a class="docs-heading-anchor-permalink" href="#Health-Checks" title="Permalink"></a></h1><p>K8sDeputy.jl provides the following health endpoints:</p><ul><li><code>/health/live</code></li><li><code>/health/ready</code></li></ul><p>These endpoints respond with HTTP status <code>200 OK</code> on success or <code>503 Service Unavailable</code> on failure.</p><h2 id="Supporting-liveness-probes"><a class="docs-heading-anchor" href="#Supporting-liveness-probes">Supporting liveness probes</a><a id="Supporting-liveness-probes-1"></a><a class="docs-heading-anchor-permalink" href="#Supporting-liveness-probes" title="Permalink"></a></h2><p>In order to enable <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#define-a-liveness-command">liveness probes</a> you will need to start the K8sDeputy health check server from within your application:</p><pre><code class="language-julia hljs">using K8sDeputy
deputy = Deputy()
K8sDeputy.serve!(deputy, &quot;0.0.0.0&quot;)

# Application code</code></pre><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>We specify the HTTP service to listen to all addresses (i.e. <code>0.0.0.0</code>) on the container as the K8s <a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/">kubelet</a> which uses the <code>livenessProbe</code> executes the requests from outside of the container.</p></div></div><p>Once <code>K8sDeputy.serve!</code> has been called the HTTP based liveness endpoint should now return successful responses.</p><p>Probe requests prior to running <code>K8sDeputy.serve!</code> will return failure responses. Application developers should consider starting the health check endpoints before running slow application initialization code. Alternatively, an <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#configure-probes"><code>initialDelaySeconds</code></a> can be added to the <code>livenessProbe</code>.</p><p>You&#39;ll also need to configure your K8s container resource to specify the <code>livenessProbe</code>. For example here&#39;s a partial manifest for a K8s pod:</p><pre><code class="language-yaml hljs">apiVersion: v1
kind: Pod
spec:
  containers:
    - name: app
      ports:
        - name: health-check
          containerPort: 8081  # The default K8sDeputy.jl heath check port
          protocol: TCP
      livenessProbe:
        httpGet:
          path: /health/live
          port: health-check
        timeoutSeconds: 5</code></pre><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>K8s probes require that applications must respond to the probe requests in under <code>timeoutSeconds</code> (defaults to 1 second). Since Julia&#39;s HTTP.jl server can be unresponsive we recommend using a <code>timeoutSeconds</code> of at least 5 seconds.</p></div></div><h2 id="Supporting-readiness-probes"><a class="docs-heading-anchor" href="#Supporting-readiness-probes">Supporting readiness probes</a><a id="Supporting-readiness-probes-1"></a><a class="docs-heading-anchor-permalink" href="#Supporting-readiness-probes" title="Permalink"></a></h2><p>Enabling <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#define-readiness-probes">readiness probes</a> is similar to <a href="#supporting-liveness-probes">enabling the liveness probes</a> but requires an call to <code>readied!</code>:</p><pre><code class="language-julia hljs">using K8sDeputy
deputy = Deputy()
K8sDeputy.serve!(deputy, &quot;0.0.0.0&quot;)

# Application initialization code

readied!(deputy)

# Application code</code></pre><p>When your application is ready you should declare your application as such with <code>readied!</code>. Doing this causes the readiness endpoint to start returning successful responses. For K8s applications responding to network traffic this endpoint is critical for ensuring timely responses to external requests. Although, defining <code>readied!</code> for non-network based applications is optional it can still be useful for administration/monitoring.</p><p>To configure your K8s container resource with a readiness probe you&#39;ll need to declare a <code>readinessProbe</code> in your manifest. For example here&#39;s a partial manifest for a K8s pod:</p><pre><code class="language-yaml hljs">apiVersion: v1
kind: Pod
spec:
  containers:
    - name: app
      ports:
        - name: health-check
          containerPort: 8081  # Default K8sDeputy.jl heath check port
          protocol: TCP
      readinessProbe:
        httpGet:
          path: /health/ready
          port: health-check
        timeoutSeconds: 5</code></pre><h2 id="Shutdown"><a class="docs-heading-anchor" href="#Shutdown">Shutdown</a><a id="Shutdown-1"></a><a class="docs-heading-anchor-permalink" href="#Shutdown" title="Permalink"></a></h2><p>When it is time to shutdown your application you should inform the deputy by running the <code>shutdown!</code> function:</p><pre><code class="language-julia hljs">using K8sDeputy
deputy = Deputy(; shutdown_handler=() -&gt; @info &quot;Shutting down&quot;)
K8sDeputy.serve!(deputy, &quot;0.0.0.0&quot;)

try
    # Application code
finally
    shutdown!(deputy)
end</code></pre><p>Once <code>shutdown!</code> is called the following occurs:</p><ol><li>The liveness endpoint starts returning failure responses</li><li>The deputy&#39;s <code>shutdown_handler</code> is called</li><li>The Julia process is terminated</li></ol><p>By default the <code>shutdown_handler</code> only has 5 seconds to complete. If your <code>shutdown_handler</code> requires more time to execute you can change the timeout by using the keyword <code>shutdown_handler_timeout</code>.</p><p>Depending on your application you may want to define multiple calls to <code>shutdown!</code>. For example you may want to call <code>shutdown!</code> from within <code>graceful_terminator</code> to enable <a href="../graceful_termination/">graceful termination support</a> for you application.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../quickstart/">« Quickstart</a><a class="docs-footer-nextpage" href="../graceful_termination/">Graceful Termination »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.5.0 on <span class="colophon-date" title="Wednesday 3 July 2024 19:21">Wednesday 3 July 2024</span>. Using Julia version 1.10.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
